(()=>{"use strict";const{log:t}=console,e=["info","warn","error"],o={info:e=>{t("%c[INFO]","color: blue; font-weight: 600;",e)},warn:e=>{t("%c[WARN]","color: #ff9905; font-weight: 600;",e)},error:e=>{t("%c[ERROR]","color: #E56353;; font-weight: 600;",e)}},n="/api/get_todos",r={"Content-Type":"application/json; charset=utf-8"};let i={todos:[],categories:[],statuses:[],icons:[]};function c(){return i}function s(t){i=t}async function a(){const t=c(),e=await caches.open("todo-sw"),o=JSON.stringify(t);await e.put(n,new Response(o,{headers:new Headers({...r,"Cache-Control":"max-age=31536000","Content-Length":String(o.length)})}))}function d(t){const e=new Date;return e.setDate(e.getDate()+t),e.toISOString()}const u={icons:[{icon_id:1,icon_name:"page.png"},{icon_id:2,icon_name:"home.png"},{icon_id:3,icon_name:"other.png"},{icon_id:4,icon_name:"warning.png"},{icon_id:5,icon_name:"alert.png"},{icon_id:6,icon_name:"ball.png"},{icon_id:7,icon_name:"bug.png"},{icon_id:8,icon_name:"cart.png"},{icon_id:9,icon_name:"favorite.png"},{icon_id:10,icon_name:"inbox.png"},{icon_id:11,icon_name:"life.png"},{icon_id:12,icon_name:"mail.png"},{icon_id:13,icon_name:"twitter.png"},{icon_id:14,icon_name:"note.png"}],statuses:[{status_id:1,status:"низкий",color:"#808080"},{status_id:2,status:"нормальный",color:"#000000"},{status_id:3,status:"повышенный",color:"#008000"},{status_id:4,status:"высокий",color:"#E56353"}],categories:[{category_id:1,icon_id:3,category:"Работа"},{category_id:2,icon_id:2,category:"Дом"},{category_id:3,icon_id:6,category:"Здоровье"},{category_id:4,icon_id:7,category:"Фигня"}],todos:[{todo_id:1,status_id:1,category_id:1,todo:"Todo1",deleted:!1},{todo_id:2,status_id:2,category_id:2,todo:"Hover your mouse over a project or item and click the icon on the right side of the item for more",due_date:d(-1)},{todo_id:3,status_id:3,category_id:3,todo:"Todo3",due_date:function(t){const e=new Date;return e.setMinutes(e.getMinutes()+1),e.toISOString()}()},{todo_id:4,status_id:4,category_id:1,todo:"Todo4",due_date:d(1),completed:!0,deleted:!1},{todo_id:5,status_id:4,todo:"Todo5"},{todo_id:6,status_id:4,todo:"Todo6",completed:!0,deleted:!1},{todo_id:7,status_id:2,todo:"Todo7",completed:!0,deleted:!0}]};async function _(){if(0===c().icons.length)try{const t=await caches.open("todo-sw"),e=await t.match(n);if(void 0!==e){const t=await e.json();t&&s(t)}0===c().icons.length&&(s(u),await a())}catch(t){o.error({message:"sw: error in loadState",error:t})}}function g(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return new Response(JSON.stringify({error:{code:500,error:t,data:e}}),{headers:r,status:200})}function l(t,e){t.respondWith(_().then((()=>e())).then((t=>(a(),t))))}function f(){return new Response(JSON.stringify({error:{code:404,error:"Not found"}}),{headers:r,status:200})}function y(t){return"number"==typeof t&&Number.isInteger(t)}function p(t){return null!=t}function h(t,e,o){return t>=e&&t<=o}function m(t){return"string"==typeof t}function w(t){return"boolean"==typeof t}function v(t){return null==t}function b(t,e){const o=Object.keys(e);for(let n=0;n<o.length;n++){const r=e[o[n]],[i,c]=r;if(!1===i(t))return{error:c}}return{entity:t}}const S=(!1,t=>{if(w(t))return t;if(m(t))switch(t.toLowerCase()){case"true":return!0;case"false":return!1;default:return}return!v(t)&&void 0});const k={todo_id:[t=>p(t.todo_id)&&y(t.todo_id),"обязательное поле todo_id должно быть целым числом"],status_id:[t=>p(t.status_id)&&y(t.status_id),"обязательное поле status_id должно быть целым числом"],category_id:[t=>v(t.category_id)||y(t.category_id),"необязательное поле category_id должно быть целым числом"],todo:[function(t){return!!m(t.todo)&&h(t.todo.length,5,100)},"длина названия todo должна быть более 5 символов и не превышать 100 символов"],description:[function(t){return!!v(t.description)||!!m(t.description)&&h(t.description.length,10,1e3)},"длина description должна быть более 10 символов и не превышать 1000 символов"],due_date:[t=>function(t){return!p(t)}(t.due_date)||m(t.due_date),"необязательное поле due_date должно быть строкой ISO 8086"],completed:[t=>w(t.completed),"поле completed должно быть boolean"],deleted:[t=>v(t.deleted)||w(t.deleted),"поле deleted должно быть boolean"]};function O(t,e){var o;const n=function(t){return b(function(t){const{todo_id:e,todo:o,status_id:n,category_id:r,description:i,due_date:c,deleted:s,completed:a}=t;return{todo_id:e,todo:(d=o,"string"==typeof d?d[0].toUpperCase()+d.slice(1):void 0),status_id:n,category_id:r,description:i,due_date:c,deleted:S(s),completed:S(a)};var d}(t),k)}(t);if(!n.entity)return n;const{entity:r}=n;return!1===e.statuses.some((t=>t.status_id===r.status_id))?{error:"Статус задачи не обнаружен в стправочнике!!"}:r.category_id&&!e.categories||!1===(null===(o=e.categories)||void 0===o?void 0:o.some((t=>r.category_id===t.category_id)))?{error:"Категория задачи не обнаружена в стправочнике!!"}:{entity:r}}function R(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return new Response(JSON.stringify({result:t}),{headers:r,status:e})}const j=[function(t){return!!m(t.category)&&h(t.category.length,3,20)},"Длина названия категории должна быть более 3 символов и не превышать 20 символов"],E=[t=>p(t.icon_id)&&y(t.icon_id),"Category обязан иметь icon_id целым числом"];function T(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{category_id:e,category:o,icon_id:n}=t;return{category_id:e,category:o,icon_id:n}}const I={category_id:[t=>p(t.category_id)&&y(t.category_id),"Category обязан иметь category_id целым числомr"],category:j,icon_id:E},N={category:j,icon_id:E};async function C(t,n){switch(n){case"create_category":return async function(t){try{const e=await t.json(),{entity:o,error:n}=function(t){return b(T(t),N)}(e);if(o){const t=c(),e=t.categories.map((t=>t.category_id))||[1],n=Math.max(...e)+1,r={...o,category_id:n};return t.categories.push(r),R(r)}return g(n)}catch(t){const{message:e,stack:o}=t;return g(e,o)}}(t);case"create_todo":return async function(t){try{const n=c(),r=await t.json(),{entity:i,error:s}=O(r,n);if(i){var e,o;const t=(null==n||null===(e=n.todos)||void 0===e?void 0:e.map((t=>t.todo_id)))||[1],r=Math.max(...t)+1,c={...i,todo_id:r};return null==n||null===(o=n.todos)||void 0===o||o.push(c),R(c)}return g(s)}catch(t){const{message:e,stack:o}=t;return g(e,o)}}(t);case"log":return async function(t){const n=await t.json(),{type:r,...i}=n;return e.includes(r)?o[r](i):o.error({msg:"Не известный тип логгирования",data:n}),new Response(null,{status:200})}(t);default:return f()}}async function x(t,e){switch(e){case"update_category":return async function(t){try{const e=c(),o=await t.json(),{entity:n,error:r}=function(t,e){var o;const n=function(t){return b(T(t),I)}(t);if(!n.entity)return n;const{entity:r}=n;return null!==(o=e.categories)&&void 0!==o&&o.find((t=>t.category===r.category))?{error:"Нарушение уникальности имени категории"}:{entity:r}}(o,e);if(n){if(0===e.categories.length)return f();const t=e.categories.findIndex((t=>t.category_id===n.category_id));return-1===t?f():(e.categories[t]=n,R(n))}return g(r)}catch(t){const{message:e,stack:o}=t;return g(e,o)}}(t);case"update_todo":return async function(t){try{const e=c(),o=await t.json(),{entity:n,error:r}=O(o,e);if(n){const t=e.categories.findIndex((t=>t.category_id===n.category_id));return-1===t?f():(e.todos[t]=n,R(n))}return g(r)}catch(t){const{message:e,stack:o}=t;return g(e,o)}}(t);default:return f()}}self.VERSION="1.0.0",self.onerror=function(t){o.error({error:"sw error:",event:t})},self.addEventListener("install",(function(t){self.skipWaiting()})),self.addEventListener("activate",(function(t){t.waitUntil(async function(){await _()}()),clients.claim()})),self.addEventListener("fetch",(async function(t){const e=t.request.clone();var o=new URL(t.request.url);const n=o.pathname.slice(5);switch(t.request.method){case"GET":!async function(t,e){"/api/get_todos"===e&&t.respondWith(_().then((()=>{const t=c();return new Response(JSON.stringify(t),{headers:r})})))}(t,o.pathname);break;case"POST":l(t,(()=>C(e,n)));break;case"PATCH":l(t,(()=>x(e,n)));break;case"DELETE":l(t,(()=>async function(t,e){switch(e){case"delete_category":return async function(t){try{const{category_id:e}=await t.json();if(void 0===e)return g("Отсутствует category_id");const o=c(),n=o.categories.findIndex((t=>t.category_id===e));if(-1===n)return f();const r=o.categories[n];return o.todos.some((t=>t.category_id===e))?g("Нельзя удалить Категорию - с ней связаны задачи!",r):(o.categories.splice(n,1),R(r))}catch(t){const{message:e,stack:o}=t;return g(e,o)}}(t);case"delete_todo":return async function(t){try{const{todo_id:e}=await t.json();if(void 0===e)return g("Отсутствует todo_id");const o=c(),n=o.todos.findIndex((t=>t.todo_id===e));if(-1===n)return f();const r=o.todos[n];return o.todos.splice(n,1),R(r)}catch(t){const{message:e,stack:o}=t;return g(e,o)}}(t);default:return f()}}(e,n)));break;default:t.respondWith(g("Не допустимый http метод"))}}))})();